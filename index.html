<!DOCTYPE html>
<!--
	Sources:
	https://bl.ocks.org/johnwalley/e1d256b81e51da68f7feb632a53c3518
	https://github.com/johnwalley/d3-simple-slider
	https://flowingdata.com/projects/2021/minimum-wage/?initialWidth=670&childId=minwage&parentTitle=How%20Much%20Minimum%20Wage%20Changed%20in%20Each%20State%20%7C%20FlowingData&parentUrl=https%3A%2F%2Fflowingdata.com%2F2021%2F03%2F01%2Fhow-much-minimum-wage-changed-in-each-state%2F

-->
<head>
<meta charset="utf-8">
<title>Minimum value by State</title>
<link rel="stylesheet" href="css/site.css" type="text/css" media="screen" />
<link rel="stylesheet" href="css/bootstrap.min.css.map">
<link href='https://fonts.googleapis.com/css?family=Inconsolata' rel='stylesheet' type='text/css'>
</head>
<div id="main-wrapper">
	<div id="heading">
		<img id="quotes" src="img/quotes.png"></img>
		<div id="title">
			<h1>Recovery policy mesures and their environmental impact</h1>
		</div>
	</div>
	<div id=intro><b>Explore the policies put in place by countries! Action the buttons</b> to see how policies are distributed. Mouse over to see the policies' details.</div>
	<div id="legend">The policy impact on the environment can greatly vary. It is illustrated by the colors which illustrate <span  class="dot positive"></span> positive, <span  class="dot negative"></span> negative, or <span  class="dot mixed"></span> mixed impact.</div>
	<div id="selCountry">
			<select id="country_dropdown" onchange="updateCouViz(value)"> 
				
			</select> ‚Üê PICK A COUNTRY TO EXPLORE ITS POLICIES
		</div>
    
    <div id="selectorButtons" class="flex-container">
				<!--<button class="button grey" id="Dimension" type="submit" value="sector" onclick="mainViz(value)"><span class="textbtn">main viz</span></button>-->
				<button class="button grey" id="launchButton" type="submit" value="sector" onclick="updateViz(value)"><span class="textbtn">Policy sector</span></button>
				<button class="button grey" id="Dimension" type="submit" value="type" onclick="updateViz(value)"><span class="textbtn">Policy type</span></button>
				<!--<button class="button grey" id="Dimension" type="submit" value="scope" onclick="updateViz(value)"><span class="textbtn">Policy scope</span></button>-->
				<button class="button grey" id="Dimension" type="submit" value="impact" onclick="updateViz(value)"><span class="textbtn">Policy impact</span></button>
		</div>
	<div id="chart"></div>
	<div id="source"><b>Source</b>: <a href="https://dx.doi.org/10.1787/67ede41b-en" target="_blank">Green Recovery Tracker</a></div>

	<img id="OECDLogo" src="img/OECD_20cm.jpg"></img>

</div>
<script src="js/d3.v6.min.js"></script>

<script>

var divCircle = d3.select("body").append("div") 
	.attr("class", "tooltip")       
	.style("opacity", 0);


var divAnnotation = d3.select("#chart").append("div") 
	.attr("class", "annotation")       
	.style("opacity", 0);


// Dimensions of chart.
let margin = { top: 30, right: 150, bottom: 30, left: 350 },
      width = parseInt(d3.select('#chart').style('width'), 10) - margin.left - margin.right,
      height = 600 - margin.top - margin.bottom,
	  minR = 5,
	  marginSlider=30;
	  widthSlider = parseInt(d3.select('#chart').style('width'), 10) - 2*marginSlider;
if (width < 500) {
    margin = { top: 30, right: 100, bottom: 30, left: 200 },
    width = parseInt(d3.select('#chart').style('width'), 10) - margin.left - margin.right,
	minR = 4,
	height = 600 - margin.top - margin.bottom;
}


//All Data
let nodes;
let alldata;

// Node spacing.
const padding = 0; // Space between nodes

//Define svg
let svg = d3.select("#chart").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  //.append("g")
    //.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

let gAll = svg.append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

let gCountry = svg.append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

let simulation;

const time_trans = 900;

let x = d3.scalePow(3)
	.range([0,width-margin.right]);

let y = d3.scaleBand()
	.range([0,height]);

let area= d3.scaleSqrt() // instead of scaleLinear()
    .range([minR, 25])

let color = d3.scaleOrdinal()
	.domain(["Negative","Indeterminate","Positive","Mixed","null"])
	.range(["#586D79","#A3A3A3","#27B499","#FF7363","#ffffff"])


let colorAll = d3.scaleOrdinal()
	.domain(["Negative","Positive-others","Mixed","null","Positive-EU",])
	.range(["#586D79","#27B499","#FF7363","#ffffff","#27B499"])

let amountColor=d3.scaleSqrt()
	.range(["#FFC2DB","#720017"])

//x-axis
let  xAxis ;
var xAxisEl ;

// y-axis
let  yAxis ;
var yAxisEl ;

let lowest,highest, circle, couValue, buttonValue;

//load country
let isoList=[];
const isolist = d3.csv("data/codeIso.csv", d3.autoType);
isolist.then(function(data){
    data.forEach(function(d){
        isoList.push(d)
    }); 
})

// Load aggregates
let aggregates=[];
const aggregate = d3.json("data/aggregate.json", d3.autoType);
aggregate.then(function(data){
    aggregates=data;
    }); 


// Load data.

const launch = d3.csv("data/test3.csv", d3.autoType);


// Once data is loaded...
launch.then(function(data){
    alldata=data
	lowest = d3.min(data,function(d){return parseFloat(d.Convert_to_USD_millions)});
	highest = d3.max(data,function(d){return parseFloat(d.Convert_to_USD_millions)});
    console.log(lowest)
    x.domain([-0.02*highest,0.1*highest])
	area.domain([lowest,0.33*highest])
    amountColor.domain([lowest,highest])
    setDropdown();
	initiateViz();
})

function initiateViz(){

    buttonValue='sector';
    couValue='All';

    /////////////////////////////////////////
    /////////// Aggregate charts ////////////
    /////////////////////////////////////////


        var diameter 
        if(width>=height)
            diameter=height;
        else
            diameter=width;

        var bubbleAll = d3.pack(aggregates)
            .size([diameter, diameter])
            .padding(1.5);


        var nodesAll = d3.hierarchy(aggregates)
            .sum(function(d) { return d.value; });

        var nodeAll = gAll.selectAll(".bubble")
            .data(bubbleAll(nodesAll).descendants())
            .enter()
            .filter(function(d){
                return  !d.children
            })
            .append("g")
        .attr("class", "nodAll")
            .attr("transform", function(d) {
                return "translate(" + d.x + "," + d.y + ")";
            });

        nodeAll.append("title")
            .text(function(d) {
                return d.name + ": " + d.value;
            });

        nodeAll.append("circle")
            .attr("r", function(d) {
                return d.r;
            })
            .style("fill", function(d,i) {
                return colorAll(d.data.name);
            });

        nodeAll.append("text")
            .attr("dy", ".2em")
            .style("text-anchor", "middle")
            .text(function(d) {
                return d.data.name.substring(0, d.r / 3);
            })
            .attr("font-family", "sans-serif")
            .attr("font-size", function(d){
                return d.r/4;
            })
            .attr("fill", "white");

        nodeAll.append("text")
            .attr("dy", "1.3em")
            .style("text-anchor", "middle")
            .text(function(d) {
                return d.data.value+ " USD billion";
            })
            .attr("font-family",  "Gill Sans", "Gill Sans MT")
            .attr("font-size", function(d){
                return d.r/5;
            })
            .attr("fill", "white");

        /*d3.select(self.frameElement)
            .style("height", diameter + "px");*/


    /////////////////////////////////////////
    /////////// country charts //////////////
    /////////////////////////////////////////
        
        
	y.domain([...new Set(alldata.map(d => d.Sector))])

	yAxis = d3.axisLeft(y)
        .tickSize(-width);

	yAxisEl = gCountry.append("g")
		.attr("class", "y axis left")
		//.attr("transform", "translate(0,"+0+")")

	yAxisEl.call(yAxis)
        .selectAll(".tick text")
        .call(wrap, 0.65*(margin.left))

  // Create node data.
    var ref=width/2

    nodes = alldata.map(function(d,i) {	

        let r2,x1;
        if(d.Convert_to_USD_millions!=null)	{
			r2= area(parseFloat(d.Convert_to_USD_millions));
            x1=x(parseFloat(d.Convert_to_USD_millions));
        }
        else{
            r2=minR-2;
            x1=x(-0.015*highest)
        }
			

        if(d.Country!=couValue)	
            r2=0;

            return {
            id: d.Identification_number,
            x: x1 ,
            y: y(d.Sector) ,
            r: r2,
            country: d.Country,
			amount: d.Convert_to_USD_millions,
			type:d.Type_of_measure,
            scope: d.Scope,
            impact: d.Env_impact_category,
            sector: d.Sector,
            summary: d.Summary_description,
            infra: d.Infrastructure_relevant,
			data: []
        }
    })

    render();

	//	render()
	function render(){
        
		// Circle for each node.
		circle = gCountry.append("g")
			.selectAll("circle")
			.data(nodes)
			.join("circle")
			.attr("id", d => "circle"+d.id)
			.attr("cx", d => d.x)
			.attr("cy", d => (y(d.sector)+y.bandwidth()/2)) //
			.attr("fill", function(d) {
                //if(d.amount!=null)
					return color(d.impact)//amountColor(parseFloat(d.amount));
                //else    
                //return "#aaa";
			})
			.attr("stroke", function(d) {
                if(d.amount==null)
					return  "#000";})
            .attr("opacity",0.75);
		
		
		// Ease in the circles.
		circle.transition()
			.delay((d,i) => i * 5)
			.duration(200)
			.attrTween("r", d => {
				const i = d3.interpolate(0, d.r);
				return t => d.r = i(t);
			});

		circle.on('mouseover', function (d) {
				d3.select("#circle"+d.srcElement.__data__.id).style("opacity",0.4)
				divCircle.transition()
					.duration(250)
					.style("opacity", 1);

				var htmlText = "<b>"+d.srcElement.__data__.country+"</b><br/><i> "+ d.srcElement.__data__.type+"</i><br/><br/>Amount: "+ d.srcElement.__data__.amount+" millions of USD<br/>Impact: "+ d.srcElement.__data__.impact+"<br/><br/><b>"+ d.srcElement.__data__.sector +":</b> " + d.srcElement.__data__.summary + "";

				divCircle.html(htmlText)
					.style("left", event.pageX - document.body.scrollLeft + "px")
					.style("top", event.pageY /*- document.body.scrollTop*/ + "px");
				})
			
			.on("mousemove", function (d) {
				divCircle
					.style("left", event.pageX - document.body.scrollLeft + 10 + "px")
					.style("top", event.pageY + "px");

			})
			.on('mouseout', function (d) {
				d3.select("#circle"+d.srcElement.__data__.id).style("opacity",0.75)
				divCircle.transition()
					.duration(100)
					.style("opacity", 0);
			})
		// Forces
		simulation = d3.forceSimulation(nodes)
			//.force("cluster", forceCluster())
            //.force('charge', d3.forceManyBody().strength(0))
			.force("x", d3.forceX(d => d.x))//.strength(strengthX))
			.force("y", d3.forceY(d => (y(d.sector)+y.bandwidth()/2)))//.strength(strengthY))
			.force("collision", d3.forceCollide().radius(d => d.r + padding + 2))
			.alpha(.25)
			.alphaDecay(0);
		
		// Adjust position of circles.
		simulation.on("tick", () => {    
			circle
				.attr("cx", d => d.x)
				.attr("cy", d => d.y)
				// .attr("fill", d => d.color);
		});
    }

    gCountry.attr("opacity",0)
}
function updateViz(value){

    //update variables
    buttonValue=value;
   
    if(couValue=="all"){
        gCountry.attr("opacity",0)
        gAll.attr("opacity",1)
        document.getElementById("selectorButtons").style.visibility = "hidden";
    }else{
        gCountry.attr("opacity",1)
        gAll.attr("opacity",0)
        document.getElementById("selectorButtons").style.visibility = "visible";
    



		nodes.forEach(function(o,i) {
            if (o.country!=couValue)
			    o.r = 0;
            else{
                if(o.amount!=null)	{
                    o.r= area(parseFloat(o.amount));
                } else{
                    o.r=minR-2;
                }
            }
		});
		// new y domain
		if(value=="sector"){
            y.domain([...new Set(alldata.map(d => d.Sector))])
            yAxisEl.transition().ease(d3.easeLinear).duration(time_trans).call(yAxis).selectAll(".tick text").call(wrap, 100);
           
            simulation
                .force("x", d3.forceX(d => d.x))//.strength(strengthX))
                .force("y", d3.forceY(d => (y(d.sector)+y.bandwidth()/2)))//.strength(strengthY))
                .force("collision", d3.forceCollide().radius(d => d.r + padding + 2));

            circle
                .transition()
                .duration(time_trans)
                .ease(d3.easeLinear)
			    .attr("r", d => d.r);

        } else if(value=="type"){
            y.domain([...new Set(alldata.map(d => d.Type_of_measure))])
            yAxisEl.transition().ease(d3.easeLinear).duration(time_trans).call(yAxis).selectAll(".tick text").call(wrap, 0.65*(margin.left));
           
            simulation
                .force("x", d3.forceX(d => d.x))//.strength(strengthX))
                .force("y", d3.forceY(d => (y(d.type)+y.bandwidth()/2)))//.strength(strengthY))
                .force("collision", d3.forceCollide().radius(d => d.r + padding + 2));

            circle
                .transition()
                .duration(time_trans)
                .ease(d3.easeLinear)
			    .attr("r", d => d.r);

        } else if(value=="scope"){
	        y.domain([...new Set(alldata.map(d => d.Scope))])
            yAxisEl.transition().ease(d3.easeLinear).duration(time_trans).call(yAxis).selectAll(".tick text").call(wrap, 0.65*(margin.left));
           
            simulation
                .force("x", d3.forceX(d => d.x))//.strength(strengthX))
                .force("y", d3.forceY(d => (y(d.scope)+y.bandwidth()/2)))//.strength(strengthY))
                .force("collision", d3.forceCollide().radius(d => d.r + padding + 2));

            circle
                .transition()
                .duration(time_trans)
                .ease(d3.easeLinear)
			    .attr("r", d => d.r);

        } else if(value=="impact"){
	        y.domain([...new Set(alldata.map(d => d.Env_impact_category))])
            yAxisEl.transition().ease(d3.easeLinear).duration(time_trans).call(yAxis).selectAll(".tick text").call(wrap, 0.65*(margin.left));
           
            simulation
                .force("x", d3.forceX(d => d.x))//.strength(strengthX))
                .force("y", d3.forceY(d => (y(d.impact)+y.bandwidth()/2)))//.strength(strengthY))
                .force("collision", d3.forceCollide().radius(d => d.r + padding + 2));

            circle
                .transition()
                .duration(time_trans)
                .ease(d3.easeLinear)
			    .attr("r", d => d.r);
        }  



    }


		
}

function updateCouViz(value){

	//update variables
     couValue = value;

    if(couValue=="all"){
        gCountry.attr("opacity",0)
        gAll.attr("opacity",1)

        document.getElementById("selectorButtons").style.visibility = "hidden";
    }else{

        gCountry.attr("opacity",1)
        gAll.attr("opacity",0)
        document.getElementById("selectorButtons").style.visibility = "visible";

		nodes.forEach(function(o,i) {
            if (o.country!=couValue)
			    o.r = 0;
            else{
                if(o.amount!=null)	
                    o.r= area(parseFloat(o.amount));
                else
                    o.r=minR-2;
            }
		});
		// new y domain
		if(buttonValue=="sector"){
            y.domain([...new Set(alldata.map(d => d.Sector))])
            yAxisEl.transition().ease(d3.easeLinear).duration(time_trans).call(yAxis).selectAll(".tick text").call(wrap, 0.65*(margin.left));
           
            simulation
                .force("x", d3.forceX(d => d.x))//.strength(strengthX))
                .force("y", d3.forceY(d => (y(d.sector)+y.bandwidth()/2)))//.strength(strengthY))
                .force("collision", d3.forceCollide().radius(d => d.r + padding + 2));

            circle
                .transition()
                .duration(time_trans)
                .ease(d3.easeLinear)
			    .attr("r", d => d.r);

        } else if(buttonValue=="type"){
            y.domain([...new Set(alldata.map(d => d.Type_of_measure))])
            yAxisEl.transition().ease(d3.easeLinear).duration(time_trans).call(yAxis).selectAll(".tick text").call(wrap, 0.65*(margin.left));
           
            simulation
                .force("x", d3.forceX(d => d.x))//.strength(strengthX))
                .force("y", d3.forceY(d => (y(d.type)+y.bandwidth()/2)))//.strength(strengthY))
                .force("collision", d3.forceCollide().radius(d => d.r + padding + 2));

            circle
                .transition()
                .duration(time_trans)
                .ease(d3.easeLinear)
			    .attr("r", d => d.r);

        } else if(buttonValue=="scope"){
	        y.domain([...new Set(alldata.map(d => d.Scope))])
            yAxisEl.transition().ease(d3.easeLinear).duration(time_trans).call(yAxis).selectAll(".tick text").call(wrap, 0.65*(margin.left));
           
            simulation
                .force("x", d3.forceX(d => d.x))//.strength(strengthX))
                .force("y", d3.forceY(d => (y(d.scope)+y.bandwidth()/2)))//.strength(strengthY))
                .force("collision", d3.forceCollide().radius(d => d.r + padding + 2));

            circle
                .transition()
                .duration(time_trans)
                .ease(d3.easeLinear)
			    .attr("r", d => d.r);

        } else if(buttonValue=="impact"){
	        y.domain([...new Set(alldata.map(d => d.Env_impact_category))])
            yAxisEl.transition().ease(d3.easeLinear).duration(time_trans).call(yAxis).selectAll(".tick text").call(wrap, 0.65*(margin.left));;
           
            simulation
                .force("x", d3.forceX(d => d.x))//.strength(strengthX))
                .force("y", d3.forceY(d => (y(d.impact)+y.bandwidth()/2)))//.strength(strengthY))
                .force("collision", d3.forceCollide().radius(d => d.r + padding + 2));

            circle
                .transition()
                .duration(time_trans)
                .ease(d3.easeLinear)
			    .attr("r", d => d.r);
        }  
    }
}

function wrap(text, width) {
  text.each(function() {
    var text = d3.select(this),
        words = text.text().split(/\s+/).reverse(),
        word,
        line = [],
        lineNumber = 0,
        lineHeight = 1.1, // ems
        y = text.attr("y"),
        dy = parseFloat(text.attr("dy")),
        tspan = text.text(null).append("tspan").attr("x", 0).attr("y", y).attr("dy", dy + "em")
    while (word = words.pop()) {
      line.push(word)
      tspan.text(line.join(" "))
      if (tspan.node().getComputedTextLength() > width) {
        line.pop()
        tspan.text(line.join(" "))
        line = [word]
        tspan = text.append("tspan").attr("x", 0).attr("y", y).attr("dy", `${++lineNumber * lineHeight + dy}em`).text(word)
      }
    }
  })
}

function setDropdown(){
   
	document.getElementById("country_dropdown").innerHTML = "<option value=\"all\" selected=\"selected\">All</option>";
	[...new Set(alldata.map(d => d.Country))].forEach(function(d){
        var countryName="";
        isoList.forEach(function(k){
            if(k.ISO==d){
                countryName=k.country;
                var x = document.getElementById("country_dropdown");
                
                var option = document.createElement("option");
                option.value = d;
                option.innerHTML = countryName;

                x.appendChild(option);
            }
            
         })
		
	
	})
}

d3.selectAll(".button.grey")
    .on("click", function () {
        d3.selectAll(".button.grey")
            .style("background-color", "#e6ebe9").style("color","#0b1e2d")
        d3.select(this)
            .style("background-color", "#04629a").style("color", "#e6ebe9")
    })

	
</script>