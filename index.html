<!DOCTYPE html>
<!--
	Sources:
	https://bl.ocks.org/johnwalley/e1d256b81e51da68f7feb632a53c3518
	https://github.com/johnwalley/d3-simple-slider
	https://flowingdata.com/projects/2021/minimum-wage/?initialWidth=670&childId=minwage&parentTitle=How%20Much%20Minimum%20Wage%20Changed%20in%20Each%20State%20%7C%20FlowingData&parentUrl=https%3A%2F%2Fflowingdata.com%2F2021%2F03%2F01%2Fhow-much-minimum-wage-changed-in-each-state%2F

-->
<head>
<meta charset="utf-8">
<title>Minimum value by State</title>
<link rel="stylesheet" href="css/site.css" type="text/css" media="screen" />
<link rel="stylesheet" href="css/bootstrap.min.css">
<link href='https://fonts.googleapis.com/css?family=Inconsolata' rel='stylesheet' type='text/css'>
</head>
<div id="main-wrapper">
	<div id="heading">
		<img id="quotes" src="img/quotes.png"></img>
		<div id="title">
			<h1>Recovery policies</h1>
			<h2>Impact on environment of the policies put in place by the states</h2>
		</div>
	</div>
	<div id=intro><b>Explore the data! Action the buttons</b> to see how policies are distributed. Mouse over to see the policies' details.</div>
	<div id="selCountry">
			<select id="country_dropdown" onchange="updateCouViz(value)">
				
			</select>
		</div>
    
    <div class="flex-container">
				<button class="button grey" id="launchButton" type="submit" value="sector" onclick="updateViz(value)"><span class="textbtn">Sector</span></button>
				<button class="button grey" id="Dimension" type="submit" value="type" onclick="updateViz(value)"><span class="textbtn">Type</span></button>
				<button class="button grey" id="Dimension" type="submit" value="scope" onclick="updateViz(value)"><span class="textbtn">Scope</span></button>
				<button class="button grey" id="Dimension" type="submit" value="impact" onclick="updateViz(value)"><span class="textbtn">Impact</span></button>
		</div>
	<div id="chart"></div>
	<img id="OECDLogo" src="img/OECD_20cm.jpg"></img>

</div>
<script src="js/d3.v6.min.js"></script>

<script>

var divCircle = d3.select("body").append("div") 
	.attr("class", "tooltip")       
	.style("opacity", 0);


var divAnnotation = d3.select("#chart").append("div") 
	.attr("class", "annotation")       
	.style("opacity", 0);


// Dimensions of chart.
let margin = { top: 30, right: 150, bottom: 30, left: 200 },
      width = parseInt(d3.select('#chart').style('width'), 10) - margin.left - margin.right,
      height = 600 - margin.top - margin.bottom,
	  r = 5,
	  marginSlider=30;
	  widthSlider = parseInt(d3.select('#chart').style('width'), 10) - 2*marginSlider;
	  
if (width < 450) {
	r = 3.5;
	height = 600 - margin.top - margin.bottom;
}


//All Data
let nodes;
let alldata;

// Node spacing.
const padding = 0; // Space between nodes

//Define svg
let svg = d3.select("#chart").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

let simulation;
let strengthX= 0.015;

const time_trans = 900;

let x = d3.scaleBand()
	//.domain([-2, 2])
	.range([0,width]);

let y = d3.scaleBand()
	//.domain([-2, 2])
	.range([0,height]);

let color = d3.scaleOrdinal()
	.domain(["Negative","Indeterminate","Positive","Mixed","EU - Positive","EU - Mixed","null"])
	.range(["#ADADAD","#00765E","#78E4CE","#FACD42","#78E4CE","#FACD42","#ffffff"])

let amountColor=d3.scaleSqrt()
	.range(["#FFC2DB","#720017"])
//x-axis
let  xAxis ;
var xAxisEl ;

// y-axis
let  yAxis ;
var yAxisEl ;

let lowest,highest, circle, couValue, buttonValue;

// Load data.
const launch = d3.csv("data/test.csv", d3.autoType);


// Once data is loaded...
launch.then(function(data){
    alldata=data
    console.log(data)
    console.log([...new Set(data.map(d => d.Sector))])
    console.log([...new Set(data.map(d => d.Type_of_measure))])
    console.log([...new Set(data.map(d => d.Scope))])
    console.log([...new Set(data.map(d => d.Env_impact_category))])

	lowest = d3.min(data,function(d){return parseFloat(d.Convert_to_USD_millions)});
	highest = d3.max(data,function(d){return parseFloat(d.Convert_to_USD_millions)});
    console.log(lowest)  
    console.log(highest)

    amountColor.domain([lowest,highest])
    setDropdown();
	initiateViz();
})

function initiateViz(){
    buttonValue='sector';
    couValue='AUS';
	
	y.domain([...new Set(alldata.map(d => d.Sector))])

	yAxis = d3.axisLeft(y)
		//.tickSize(8)
		.tickPadding(5);

	yAxisEl = svg.append("g")
		.attr("class", "y axis left")
		//.attr("transform", "translate(0,"+0+")")

	yAxisEl.call(yAxis)
        .selectAll(".tick text")
        .call(wrap, 0.65*(margin.left))

  // Create node data.
    var ref=width/2

    nodes = alldata.map(function(d,i) {	
        var r2 = r;
        if(d.Country!=couValue)	
            r2=0;

        return {
            id: d.Identification_number,
            x: ref ,
            y: y(d.Sector) ,
            r: r2,
            country: d.Country,
			amount: d.Convert_to_USD_millions,
			type:d.Type_of_measure,
            color: "#e0e0e0",
            scope: d.Scope,
            impact: d.Env_impact_category,
            sector: d.Sector,
            summary: d.Summary_description,
			data: []
        }
    })
    /**	var count=0;
	nodes.forEach(function(k){
		alldata.forEach(function(d){
			if(k.id==d.ISO){
				k.data[d.Year]=[d.avg,d.inequality];
			}
		})
		count++;
		if(count==nodes.length){
			render(val)	;
		}	
	})**/
    render();

	//	render()
	function render(){
        
		// Circle for each node.
		circle = svg.append("g")
			.selectAll("circle")
			.data(nodes)
			.join("circle")
			.attr("id", d => "circle"+d.id)
			.attr("cx", d => d.x)
			.attr("cy", d => (y(d.sector)+y.bandwidth()/2)) //
			.attr("fill", function(d) {
                if(d.amount!=null)
					return amountColor(parseFloat(d.amount));
                else    
                return "#aaa";
			})
			.attr("stroke", "#aaa");
		
		
		// Ease in the circles.
		circle.transition()
			.delay((d,i) => i * 5)
			.duration(200)
			.attrTween("r", d => {
				const i = d3.interpolate(0, d.r);
				return t => d.r = i(t);
			});

		circle.on('mouseover', function (d) {
				d3.select("#circle"+d.srcElement.__data__.id).style("opacity",0.5)
				divCircle.transition()
					.duration(250)
					.style("opacity", 1);
				var htmlText = "<b>" + d.srcElement.__data__.summary + "</b>";
				divCircle.html(htmlText)
					.style("left", event.pageX - document.body.scrollLeft + "px")
					.style("top", event.pageY /*- document.body.scrollTop*/ + "px");
				})
			
			.on("mousemove", function (d) {
				divCircle
					.style("left", event.pageX - document.body.scrollLeft + 10 + "px")
					.style("top", event.pageY + "px");

			})
			.on('mouseout', function (d) {
				d3.select("#circle"+d.srcElement.__data__.id).style("opacity",1)
				divCircle.transition()
					.duration(100)
					.style("opacity", 0);
			})
		// Forces
		simulation = d3.forceSimulation(nodes)
			// .force("cluster", forceCluster())
            //.force('charge', d3.forceManyBody().strength(-2))
			.force("x", d3.forceX(width/2).strength(strengthX))
			.force("y", d3.forceY(d => (y(d.sector)+y.bandwidth()/2)))
			.force("collision", d3.forceCollide().radius(d => d.r + padding + 2))
			.alpha(.25)
			.alphaDecay(0);
		
		// Adjust position of circles.
		simulation.on("tick", () => {    
			circle
				.attr("cx", d => d.x)
				.attr("cy", d => d.y)
				// .attr("fill", d => d.color);
		});
    }
}
function updateViz(value){
	//update variables
     buttonValue=value;

		nodes.forEach(function(o,i) {
            if (o.country!=couValue)
			    o.r = 0;
            else
                o.r =r;
		});
		// new y domain
		if(value=="sector"){
            y.domain([...new Set(alldata.map(d => d.Sector))])
            yAxisEl.transition().ease(d3.easeLinear).duration(time_trans).call(yAxis).selectAll(".tick text").call(wrap, 0.65*(margin.left));
           
            simulation
                .force("x", d3.forceX(width/2).strength(strengthX))
                .force("y", d3.forceY(d => (y(d.sector)+y.bandwidth()/2)))
                .force("collision", d3.forceCollide().radius(d => d.r + padding + 2));

            circle
                .transition()
                .duration(time_trans)
                .ease(d3.easeLinear)
			    .attr("r", d => d.r);

        } else if(value=="type"){
            y.domain([...new Set(alldata.map(d => d.Type_of_measure))])
            yAxisEl.transition().ease(d3.easeLinear).duration(time_trans).call(yAxis).selectAll(".tick text").call(wrap, 0.65*(margin.left));
           
            simulation
                .force("x", d3.forceX(width/2).strength(strengthX))
                .force("y", d3.forceY(d => (y(d.type)+y.bandwidth()/2)))
                .force("collision", d3.forceCollide().radius(d => d.r + padding + 2));

            circle
                .transition()
                .duration(time_trans)
                .ease(d3.easeLinear)
			    .attr("r", d => d.r);

        } else if(value=="scope"){
	        y.domain([...new Set(alldata.map(d => d.Scope))])
            yAxisEl.transition().ease(d3.easeLinear).duration(time_trans).call(yAxis).selectAll(".tick text").call(wrap, 0.65*(margin.left));
           
            simulation
                .force("x", d3.forceX(width/2).strength(strengthX))
                .force("y", d3.forceY(d => (y(d.scope)+y.bandwidth()/2)))
                .force("collision", d3.forceCollide().radius(d => d.r + padding + 2));

            circle
                .transition()
                .duration(time_trans)
                .ease(d3.easeLinear)
			    .attr("r", d => d.r);

        } else if(value=="impact"){
	        y.domain([...new Set(alldata.map(d => d.Env_impact_category))])
            yAxisEl.transition().ease(d3.easeLinear).duration(time_trans).call(yAxis).selectAll(".tick text").call(wrap, 0.65*(margin.left));
           
            simulation
                .force("x", d3.forceX(width/2).strength(strengthX))
                .force("y", d3.forceY(d => (y(d.impact)+y.bandwidth()/2)))
                .force("collision", d3.forceCollide().radius(d => d.r + padding + 2));

            circle
                .transition()
                .duration(time_trans)
                .ease(d3.easeLinear)
			    .attr("r", d => d.r);
        }  

		
}

function updateCouViz(value){

	//update variables
     couValue = value;



		nodes.forEach(function(o,i) {
            if (o.country!=couValue)
			    o.r = 0;
            else
                o.r =r;
		});
		// new y domain
		if(buttonValue=="sector"){
            y.domain([...new Set(alldata.map(d => d.Sector))])
            yAxisEl.transition().ease(d3.easeLinear).duration(time_trans).call(yAxis).selectAll(".tick text").call(wrap, 0.65*(margin.left));
           
            simulation
                .force("x", d3.forceX(width/2).strength(strengthX))
                .force("y", d3.forceY(d => (y(d.sector)+y.bandwidth()/2)))
                .force("collision", d3.forceCollide().radius(d => d.r + padding + 2));

            circle
                .transition()
                .duration(time_trans)
                .ease(d3.easeLinear)
			    .attr("r", d => d.r);

        } else if(buttonValue=="type"){
            y.domain([...new Set(alldata.map(d => d.Type_of_measure))])
            yAxisEl.transition().ease(d3.easeLinear).duration(time_trans).call(yAxis).selectAll(".tick text").call(wrap, 0.65*(margin.left));
           
            simulation
                .force("x", d3.forceX(width/2).strength(strengthX))
                .force("y", d3.forceY(d => (y(d.type)+y.bandwidth()/2)))
                .force("collision", d3.forceCollide().radius(d => d.r + padding + 2));

            circle
                .transition()
                .duration(time_trans)
                .ease(d3.easeLinear)
			    .attr("r", d => d.r);

        } else if(buttonValue=="scope"){
	        y.domain([...new Set(alldata.map(d => d.Scope))])
            yAxisEl.transition().ease(d3.easeLinear).duration(time_trans).call(yAxis).selectAll(".tick text").call(wrap, 0.65*(margin.left));
           
            simulation
                .force("x", d3.forceX(width/2).strength(strengthX))
                .force("y", d3.forceY(d => (y(d.scope)+y.bandwidth()/2)))
                .force("collision", d3.forceCollide().radius(d => d.r + padding + 2));

            circle
                .transition()
                .duration(time_trans)
                .ease(d3.easeLinear)
			    .attr("r", d => d.r);

        } else if(buttonValue=="impact"){
	        y.domain([...new Set(alldata.map(d => d.Env_impact_category))])
            yAxisEl.transition().ease(d3.easeLinear).duration(time_trans).call(yAxis).selectAll(".tick text").call(wrap, 0.65*(margin.left));;
           
            simulation
                .force("x", d3.forceX(width/2).strength(strengthX))
                .force("y", d3.forceY(d => (y(d.impact)+y.bandwidth()/2)))
                .force("collision", d3.forceCollide().radius(d => d.r + padding + 2));

            circle
                .transition()
                .duration(time_trans)
                .ease(d3.easeLinear)
			    .attr("r", d => d.r);
        }  

}

function wrap(text, width) {
  text.each(function() {
    var text = d3.select(this),
        words = text.text().split(/\s+/).reverse(),
        word,
        line = [],
        lineNumber = 0,
        lineHeight = 1.1, // ems
        y = text.attr("y"),
        dy = parseFloat(text.attr("dy")),
        tspan = text.text(null).append("tspan").attr("x", 0).attr("y", y).attr("dy", dy + "em")
    while (word = words.pop()) {
      line.push(word)
      tspan.text(line.join(" "))
      if (tspan.node().getComputedTextLength() > width) {
        line.pop()
        tspan.text(line.join(" "))
        line = [word]
        tspan = text.append("tspan").attr("x", 0).attr("y", y).attr("dy", `${++lineNumber * lineHeight + dy}em`).text(word)
      }
    }
  })
}

function setDropdown(){
   
	//document.getElementById("country_dropdown").innerHTML = "<option value=\"-\" selected=\"selected\"> - </option>";
	[...new Set(alldata.map(d => d.Country))].forEach(function(d){
		
		var x = document.getElementById("country_dropdown");
		
		var option = document.createElement("option");
		option.value = d;
		option.innerHTML = d;

		x.appendChild(option);
	
	})
}

d3.selectAll(".button.grey")
    .on("click", function () {
        d3.selectAll(".button.grey")
            .style("background-color", "#e6ebe9").style("color","#0b1e2d")
        d3.select(this)
            .style("background-color", "#04629a").style("color", "#e6ebe9")
    })

	
</script>